import { Image, Grid } from "@phobon/base"
import { Picture, Figure, FigureGrid, ImageGrid } from "@/components"
import { Meta } from "@/components/Meta"

<Meta
  description="Refactoring 10 Years of Legacy"
  url="https://phobon.io/writing/refactoring-10-years-of-legacy"
  image="https://phobon.io/writing/refactoring-10-years-of-legacy/index.webp"
/>

# Refactoring 10 Years of Legacy

During my time at Agworld, I was empowered to embark on a project to repay back some of the technical, and design-debt that had built up in their core product over a decade. The specific area to look at here was the way the web product handled styling to improve performance, legibility, accessibility, and overall developer experience.

Agworld takes its technology very seriously, so this was seen as an extremely important project that I was well-suited to tackle.

## Four Bootstrap-sized Problems

The Agworld codebase at the time was an interesting study of its history. Interesting decisions around styling in an environment that was constantly in flux. Tastes change, personnel change, and "best practices" change, and that was all represented quite prominently.

Agworld is a Ruby-on-Rails codebase with a multi-page, micro-frontend architecture; this gave the flexibility to be able to serve any type of experience written in any way easily, but also created significant technical, design and logical issues.

The main problems and pain points that I identified here were:

- Every page potentially used a different layout, so while they _looked_ very similar, the underlying code was actually very different - leading to questionable architectural decisions in regards to global accessibility of data and functions
- Every page served 4 (FOUR) versions of the popular styling library Bootstrap
- All of these resources blocked rendering (javascript, css, etc)
- Performance budgets were either well-exceeded, or undefined

## How to Eat an Elephant

> for each desired change, make the change easy (warning: this may be hard), then make the easy change - Kent Beck

This is far easier than it sounds - hence the warning! It was extremely difficult to visualise the entire breadth of the project, so I divided work into high-level contexts, and then those contexts into steps that could be shipped incrementally. The entire project was completed over the course of 3 months in a team dedicated to technical improvements. I led the project with assistence from others in that team

### Defer-loading Resources

Initially, identifying key performance budgets and metrics was the top priority for this project. Time to Interactive (TTI) and First Contentful Paint (FCP) were identified as the most important metrics to concentrate on.

While the largest problem here was clearly the size of the payload that needed to be served, the order that it was loaded was also something that needed to be rectified.

Reducing the size of the payload would need to come later, so the first change to make here was to make sure that these resources were defer-loaded, or loaded asynchronously, so that it didn't block the critical rendering path.

Completing this improved these key metrics by orders of magnitude, and allowed some of the other more impactful refactoring to take place

### Splitting and Removing CSS Dead Wood

As mentioned earlier, one of the biggest issues we faced was the massive size of the CSS payload that users were forced to download - often several times a day given how often Agworld as a team shipped work.

The great majority of this payload was unused - meaning it had literally no impact on the final product. On some of the most heavily used pages of the site, over 95% of the served CSS was unused.

This was made even more complicated given that each page could be using one of 3 different base layouts, that each utilised different resources in a single - massive - payload, regardless of whether they were needed or not. For example, one layout my be using a combination of Bootstrap 3, and other custom styles, and another may be using Bootstrap 4 with its own custom styles.

The solution here was to split these resources up to serve only what was required for one particular page or layout.

This was a significant refactor and re-architecture effort that was potentially very volatile, so significant time and effort was put into ensuring this was completed safely.

### Consolidating layout

The last really important step in this effort was to concolidate the three vastly different layouts into one single experience.

Doing this would massively unblock efforts for future refactoring, working on responsive layout for Agworld, and dramatically reducing the burden and complexity on developers working on new and existing features.

#### Sandbox Resources

The problem here was was figuring out how to ensure legacy content and experiences still behaved as desired with a common layout.

I decided to use a sandboxing strategy to isolate resources, layout, and content based on the different layout "contexts" that I identified. Each layout context served namespaced layout, resets, and resources required for that layout - effectively shielding it from other, potentially damaging influences.

This meant that legacy content could safely be maintained, regardless of other work that had been undertaken - a huge win!

### Improving Experience - Perceived performance

Improving performance metrics is certainly a great way to improve the overall experience that someone has with your product, but there are times when doing this can unintentionally create a poor experience. Deferring the loading of styling assets - in this instance - created quite a significany Flash of Unstyled Content (FOUC). This is where the structure of a page loads in a raw, unstyled form before styling is loaded and applied.

While the product loaded significantly faster than it did before, the overall experience _felt_ worse because of this FOUC, so I created a flexible "loading experience" for developers to opt into and customise to the experience that they wanted to achieve.

Like all things, making sensible defaults and opt-in experiences is important to improving the overall developer experience.

### Clearing the Path Forward

This was one of the most impactful technological projects I undertook during my time at Agworld; taking 10 years of legacy front-end code, and achieving some significant outcomes:

- The complexity of the developer experience was significantly reduced
- Performance metrics improved by orders of magnitude
- Drastically improved real and perceived performance
- Solidified overall user experience to create a cohesive, consitent product
